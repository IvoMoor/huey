<!doctype html>
<html
>
  <head>
    <title>Huey</title>
    <link 
      rel="icon" 
      href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLXRhYmxlIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBzdHJva2U9Im5vbmUiIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMyA1YTIgMiAwIDAgMSAyIC0yaDE0YTIgMiAwIDAgMSAyIDJ2MTRhMiAyIDAgMCAxIC0yIDJoLTE0YTIgMiAwIDAgMSAtMiAtMnYtMTR6IiAvPjxwYXRoIGQ9Ik0zIDEwaDE4IiAvPjxwYXRoIGQ9Ik0xMCAzdjE4IiAvPjwvc3ZnPg=="
    />
    <script>
    function resourceLoaded(url){
      console.log(`Loaded ${url}`);
      var list = document.getElementById('resources');
      if (!list) {
        return;
      }
      var item = document.createElement('li');
      item.innerText = url;
      list.appendChild(item);
    }
    </script>
    <link 
      onload="resourceLoaded(this.href)" 
      rel="preload" 
      as="font" 
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/fonts/tabler-icons.woff2?v2.44.0" 
      type="font/woff2" 
      crossorigin="true"
    />
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Theme/General.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="spinner/Spinner.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="App/App.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Tabs/Tabs.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="AboutDialog/AboutDialog.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="ErrorDialog/ErrorDialog.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="SettingsDialog/SettingsDialog.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="SettingsDialog/SettingsDialogLogic.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="UploadUi/UploadUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Tree/Tree.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="DataSource/DataSourcesUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="util/resize/resize.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Search/Search.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="AttributeUi/AttributeUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="QueryUi/QueryUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="PivotTableUi/PivotTableUi.css"/>
  </head>
  <body>

    <div id="spinner">
      <div class="loader">Loading...</div>
      <ul id="resources" style="position:absolute; top: 0px" ></ul>
    </div>

    <dialog id="uploadUi">
      <header>
        <h3></h3>
      </header>
      <section id="uploadProgressList">
        
      </section>
      <footer>
        <button id="uploadDialogOkButton">Ok</button>
        <button id="uploadDialogCancelButton">Cancel</button>
      </footer>
    </dialog>

    <dialog id="errorDialog">
      <header>
        <h3 id="errorDialogTitle"></h3>
      </header>
      <section id="errorDialogDescription">
      </section>
      <footer>
        <button id="errorDialogOkButton">Ok</button>
      </footer>
    </dialog>

    <dialog id="settingsDialog">
      <header>
        <h3>Settings</h3>
      </header>
      <section 
        id="settingsTabs"
        class="tabs"
      >
        <div class="tabPage"><span class="tab"></span></div>
        
        <!--
          Datasources settings
        -->
        <div class="tabPage">
          <label 
            class="tab"
            for="datasourcesSettingTab"
          >
            Datasources
          </label>
          <input id="datasourcesSettingTab" type="radio" name="settingsTabs" class="tabState" checked="true"/>
          <div class="tabPageContents">
            <form id="datasourceSettings">
              <label for="registeredFileTypes">UNION loose typing</label>
              <input id="useLooseColumnTypeComparison" type="checkbox"/>
            </form>
          </div>
        </div>
        <!--
          File settings
        -->
        <div class="tabPage">
          <label 
            class="tab"
            for="fileSettingTab"
          >
            Files
          </label>
          <input id="fileSettingTab" type="radio" name="settingsTabs" class="tabState"/>
          <div class="tabPageContents">
            <form id="fileSettings">
              <label for="registeredFileTypes">File types</label>
              <select id="registeredFileTypes">
                <!--
                <option value=".csv" selected="true">Comma seperated (*.csv)</option>
                <option value=".json">JSON (*.json)</option>
                <option value=".parquet">Parquet (*.parquet)</option>
                <option value=".txt">Text (*.txt)</option>
                -->
              </select>
              <label for="defaultActionForFileType">File type default action</label>
              <select id="defaultActionForFileType">
                <!--
                <option value="SelectFrom" selected="true">SELECT FROM</option>
                <option value="csvWizard">csv wizard</option>
                <option value="jsonWizard">json wizard</option>
                <option value="parquetWizard">parquet wizard</option>
                -->
              </select>
            </form>
          </div>
        </div>
        
        <!--
          Locale Settings
        -->
        <div class="tabPage">
          <label 
            class="tab"
            for="localeSettingsTab"
          >
            Locale
          </label>
          <input id="localeSettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div class="tabPageContents">
            <form id="localeSettings">
              <label for="useDefaultLocale">Use default</label>
              <input id="useDefaultLocale" type="checkbox"/>
              <!--
                see: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl
                A locale identifier is a string that consists of:

                A language subtag with 2–3 or 5–8 letters
                A script subtag with 4 letters Optional
                A region subtag with either 2 letters or 3 digits Optional
                One or more variant subtags (all of which must be unique), each with either 5–8 alphanumerals or a digit followed by 3 alphanumerals Optional
                One or more BCP 47 extension sequences Optional
                A private-use extension sequence Optional              
              -->
              <label for="locale">Locale</label>
              <!-- 
                on change we should try to call Intl.DisplayNames.supportedLocalesOf('DE-AU'). this will return an array
                and if that is empty it probably means the entered locale is either not valid or not supported.
              -->
              <input id="locale"  
                pattern="^(([A-Za-z]{2,3}|[A-Za-z]{5,8})(-[A-Za-z]{4})?(-([A-Za-z]{2}|\d{3}))?(-([0-9A-Za-z]{5,8}|\d[0-9A-Za-z]{3}))?)(\s*,\s*(([A-Za-z]{2,3}|[A-Za-z]{5,8})(-[A-Za-z]{4})?(-([A-Za-z]{2}|\d{3}))?(-([0-9A-Za-z]{5,8}|\d[0-9A-Za-z]{3}))?))*$"
                data-value-getter="new Function('control','settings','return control.value.split(String.fromCharCode(44));')"
                data-value-setter="new Function('control','value','settings','control.value = value.join();')"
              />
              <!-- minimum integer digits -->
              <label for="minimumIntegerDigits">Min. integer digits</label>
              <input id="minimumIntegerDigits" type="number" min="1" max="21" value="1"/>
              <!-- minimum fraction digits -->
              <label for="minimumFractionDigits">Min. fraction digits</label>
              <input id="minimumFractionDigits" type="number" min="0" max="20" value="2"/>
              <!-- maximum fraction digits -->
              <label for="maximumFractionDigits">Max. fraction digits</label>
              <input id="maximumFractionDigits" type="number" min="0" max="20" value="2"/>
            </form>
          </div>
        </div>
        
        <!--
          Query settings
        -->        
        <div class="tabPage">        
          <label 
            class="tab"
            for="querySettingsTab"
          >
            Query
          </label>
          <input id="querySettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div class="tabPageContents">
            Query Settings
          </div>
        </div>
        
        <!--
          Pivot Table Settings
        -->
        <div class="tabPage">
          <label 
            class="tab"
            for="pivotTableSettingsTab"
          >
            Pivot Table
          </label>
          <input id="pivotTableSettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div class="tabPageContents">
            <form id="pivotTableSettings">
            </form>
          </div>
        </div>

        <!--
          Theme
        -->
        <div class="tabPage">
          <label 
            class="tab"
            for="themeSettingsTab"
          >
            Theme
          </label>
          <input id="themeSettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div class="tabPageContents">
            <form id="themeSettings">
              <label for="themes">Themes</label>
              <select 
                id="themes" 
                onchange="Theme.applyTheme(this.selectedIndex)"
                data-value-getter="new Function('control', 'settings', 'return JSON.parse(control.value);')"
                data-value-setter="new Function('control', 'value', 'settings', 'control.value = JSON.stringify(value);')"
              >
              </select>
            </form>
          </div>
        </div>
        
        <div class="tabPage"><span class="tab"></span></div>
      </section>
      <footer>
        <button id="settingsDialogOkButton">Ok</button>
        <button id="settingsDialogCancelButton">Cancel</button>
      </footer>
    </dialog>

    <dialog id="aboutDialog">
      <header>
        <h3>Huey</h3>
      </header>
      <section>
        <p>
          A simple DuckDB UI - by Roland.Bouman@gmail.com
        </p>
        <ul>
          <li id="duckdbVersionLabel"></li>
          <li><a href="https://github.com/rpbouman/huey/" target="_github">Github</a></li>
          <li><a href="https://raw.githubusercontent.com/rpbouman/huey/dev/LICENSE" target="_github">License</a></li>
        </ul>
      </section>
      <footer>
        <button id="aboutDialogOkButton">Ok</button>
      </footer>
    </dialog>
        
    <main
      id="layout" 
      class="layout"
      style="display: none"
    >
      <menu class="toolbar" role="toolbar">
        <label 
          for="uploader"
          title="Open a file browser to register a file."
        >
          <input 
            id="uploader" 
            type="file"
            multiple="true"
            accept=".csv,.duckdb,.json,.parquet,.sql,.sqlite,.tsv,.xlsx"
          />
        </label>
        <h1 id="currentDatasource">
        </h1>
        <label id="aboutButton" class="aboutButton" title="About Huey...">
          <button
            id="aboutButton"
          >About</button>
        </label>      
        <label
          for="settingsButton"
          class="button settings"
          title="Open the Huey Settings dialog."
        >
          <button
            id="settingsButton"
          >Settings</button>
        </label>
      </menu>
      <nav class="resizeHorizontal sidebar tabs">
        <div class="tabPage">
          <span 
            class="tab"
          ></label>
        </div>
        
        <!-- Datasources tab --> 
        <div 
          class="tabPage"
        >
          <label 
            for="datasourcesTab" 
            class="tab"
            title="Files, database tables and so on that provide data you'd like to analyze."
          >Datasources</label>
          <input id="datasourcesTab" type="radio" name="sidebarTabs" class="tabState" checked="true"/>
          <div id="datasourcesUi" class="tree tabPageContents">
          </div>
        </div>
        
        <!-- Attributes tab -->
        <div class="tabPage">
          <label 
            for="attributesTab" 
            class="tab"
            title="Columns, formulas and aggregates to query and pivot"
          >Attributes</label>
          <input id="attributesTab" type="radio" name="sidebarTabs" class="tabState"/>
          <div class="tabPageContents">
            <search 
              id="searchAttributeUi"
              class="search" 
              style="display:none"
            >
              <fieldset>
                <legend>Search</legend>
                <input 
                  id="searchAttribute"
                  type="search"
                  placeholder="Search by Attribute name"
                />
              </fieldset>
            </search>
            <div 
              id="attributeUi" 
              class="tree attributeUi"
              style="flex-grow: 1;"
            >
            </div>
          </div>          
        </div>
        
        <div class="tabPage">
          <span 
            class="tab"
          ></label>
        </div>
      </nav>
      <div class="workarea">
        <table
          id="queryUi"
          class="queryUi"
          data-cellheadersaxis="columns"
          border="0"
          cellspacing="2"
          cellpadding="0"
          style="
            display: none;
            flex-grow: 0;
          "
        >
          <tbody class="queryUiAxes">
            <tr class="queryUiAxis" data-axis="columns">
              <td class="axisIcon" title="Flip rows and columns axes"></td>
              <td class="label"></td>
              <td class="items"></td>
              <td class="clearAxisButton" title="Clear columns axis"></td>
            </tr>
            <tr class="queryUiAxis" data-axis="rows">
              <td class="axisIcon" title="Flip rows and columns axes"></td>
              <td class="label"></td>
              <td class="items"></td>
              <td class="clearAxisButton" title="Clear rows axis"></td>
            </tr>
            <tr class="queryUiAxis" data-axis="cells">
              <td class="axisIcon"></td>
              <td class="label"></td>
              <td class="items"></td>
              <td class="clearAxisButton" title="Clear cells axis"></td>
            </tr>
          </tbody>
        </table>
        <!-- pivotTableUi: outmost container of the pivot table-->
        <div
          id="pivotTableUi"
          class="pivotTableUiContainer"
          style="
            flex-grow: 1;
            width: 100%;
            height: 100%;
            border-width: 1px;
            border-color: var( --huey-dark-border-color );
            border-top-style: solid;
          "
          data-updating="false"
        >
          <div 
            class="pivotTableUiInnerContainer"
          >
            <!-- pivotTableColumnsSizer: sizer to generate the horizontal scrollbar -->
            <div class="pivotTableUiSizer pivotTableUiHorizontalSizer"></div>
            <!-- pivotTableColumnsSizer: sizer to generate the vertical scrollbar -->
            <div class="pivotTableUiSizer pivotTableUiVerticalSizer"></div>
            
            <!-- the actual table structure -->
            <div  
              class="pivotTableUiTable"
            >
              <div class="pivotTableUiTableHeader"></div>
              <div class="pivotTableUiTableBody"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <script onload="resourceLoaded(this.src)" src="util/dom/dom.js"></script>
    <script onload="resourceLoaded(this.src)" src="util/event/EventEmitter.js"></script>
    <script onload="resourceLoaded(this.src)" src="util/event/EventBuffer.js"></script>

    <script onload="resourceLoaded(this.src)" src="SettingsDialog/SettingsDialog.js"></script>
    <script onload="resourceLoaded(this.src)" src="Theme/Theme.js"></script>

    <script onload="resourceLoaded(this.src)" src="util/sql/SQLHelper.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSource/duckdb/DuckDbDataSource.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSet/TupleSet.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSet/CellSet.js"></script>
    <script onload="resourceLoaded(this.src)" src="AboutDialog/AboutDialog.js"></script>
    <script onload="resourceLoaded(this.src)" src="ErrorDialog/ErrorDialog.js"></script>
    <script onload="resourceLoaded(this.src)" src="UploadUi/UploadUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSource/DataSourcesUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="AttributeUi/AttributeUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="Search/Search.js"></script>
    <script onload="resourceLoaded(this.src)" src="QueryModel/QueryModel.js"></script>
    <script onload="resourceLoaded(this.src)" src="QueryUi/QueryUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="PivotTableUi/PivotTableUi.js"></script>   

    <script onload="resourceLoaded(this.src)" src="App/App.js"></script>
    <script type="module">
      import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

      const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
      const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

      const worker_url = URL.createObjectURL(
        new Blob([`importScripts("${bundle.mainWorker}");`], {type: 'text/javascript'})
      );
      const worker = new Worker(worker_url);
      const logger = new duckdb.ConsoleLogger();
      const db = new duckdb.AsyncDuckDB(logger, worker);
      
      await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
      const connection = await db.connect();
      URL.revokeObjectURL(worker_url);    
      
      window.hueyDb = {
        duckdb: duckdb,
        instance: db,
        connection: connection
      };
      
      initApplication();
    </script>
  </body>
</html>