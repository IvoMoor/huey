<!doctype html>
<html
>
  <head>
    <title>Huey</title>
    <link 
      rel="icon" 
      href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGNsYXNzPSJpY29uIGljb24tdGFibGVyIGljb24tdGFibGVyLXRhYmxlIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBzdHJva2U9Im5vbmUiIGQ9Ik0wIDBoMjR2MjRIMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMyA1YTIgMiAwIDAgMSAyIC0yaDE0YTIgMiAwIDAgMSAyIDJ2MTRhMiAyIDAgMCAxIC0yIDJoLTE0YTIgMiAwIDAgMSAtMiAtMnYtMTR6IiAvPjxwYXRoIGQ9Ik0zIDEwaDE4IiAvPjxwYXRoIGQ9Ik0xMCAzdjE4IiAvPjwvc3ZnPg=="
    />
    <script>
    function resourceLoaded(url){
      console.log(`Loaded ${url}`);
      var list = document.getElementById('resources');
      if (!list) {
        return;
      }
      var item = document.createElement('li');
      item.innerText = url;
      list.appendChild(item);
    }
    </script>
    <link 
      onload="resourceLoaded(this.href)" 
      rel="preload" 
      as="font" 
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/fonts/tabler-icons.woff2?v2.44.0" 
      type="font/woff2" 
      crossorigin="true"
    />
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Theme/General.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="spinner/spinner.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="spinner/timer.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="App/App.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Tabs/Tabs.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="AboutDialog/AboutDialog.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="ErrorDialog/ErrorDialog.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="SettingsDialog/SettingsDialog.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="SettingsDialog/SettingsDialogLogic.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="ExportUi/ExportUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="UploadUi/UploadUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Tree/Tree.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="DataSource/DataSourcesUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="util/resize/resize.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="Search/Search.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="AttributeUi/AttributeUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="QueryUi/QueryUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="FilterUi/FilterUi.css"/>
    <link onload="resourceLoaded(this.href)" rel="stylesheet" type="text/css" href="PivotTableUi/PivotTableUi.css"/>
  </head>
  <body>

    <div id="spinner">
      <div class="loader">Loading...</div>
      <ul id="resources" style="position:absolute; top: 0px" ></ul>
    </div>

    <dialog id="uploadUi">
      <header>
        <h3></h3>
        <div class="timer">
          <span class="digit"></span>
          <span class="digit"></span>
          <span class="digit"></span>
          <span class="digit"></span>
        </div>
      </header>
      <section id="uploadProgressList">
        
      </section>
      <footer>
        <button id="uploadDialogOkButton">Ok</button>
        <button id="uploadDialogCancelButton">Cancel</button>
      </footer>
    </dialog>

    <dialog id="exportDialog">
      <header>
        <h3>Export...</h3>
      </header>
      <section >
        <fieldset>
          <legend>DuckDB Pivot statement (SQL)</legend>
          <menu role="menu">
            <li role="menuitem">
              <label for="copyPivotStatementToClipboard">Copy to clipboard...
                <button id="copyPivotStatementToClipboard">Copy to clipboard...</button>
              </label>
            </li>
            <li role="menuitem">
              <label for="downloadPivotStatementToSqlFile">Download as SQL file...
                <button id="downloadPivotStatementToSqlFile">Download as SQL file...</button>
              </label>
            </li>
          </menu>
        </fieldset>
        <fieldset>
          <legend>Pivot Statement Results</legend>
          <menu role="menu">
            <li role="menuitem">
              <label for="downloadQueryResultsAsCsvFile">Download as .csv file...
                <button id="downloadQueryResultsAsCsvFile">Download as .csv file...</button>
              </label>
            </li>
            <li role="menuitem">
              <label for="downloadQueryResultsAsParquetFile">Download as .parquet file...
                <button id="downloadQueryResultsAsParquetFile">Download as .parquet file...</button>
              </label>
            </li>
          </menu>
        </fieldset>
      </section>
      <footer>
        <button id="exportDialogCloseButton">Close</button>
      </footer>
    </dialog>
    
    <dialog id="filterDialog" aria-busy="false">
      <header>
        <label for="filterType">Filter type:</label>
        <select id="filterType">
          <option value="in">Include</option>
          <option value="notin">Exclude</option>
          <option value="between">Between</option>
        </select>
      </header>
      <section>
        <header>
          <section>
            <div id="filterDialogSpinner" class="loader loader-medium"></div>
            <header>
              <input
                id="filterSearch"
                placeholder="Use a LIKE pattern to find values..." 
                type="search"
                title="Enter a search string to filter the value picklist (LIKE wildcards supported)"
              />
            </header>
            <section>
              <select 
                id="filterPicklist"
                multiple="true" 
                size="5"
                title="Choose values from the picklist to add them to the Filter values list"
              >
              </select>
            </section>
            <footer id="searchStatus" role="status">No values found.</footer>
          </section>
        </header>
        <section>
          <div>
            <label for="filterValueList">Select values:</label>
            <select 
              id="filterValueList"
              multiple="true" 
              size="7"
              title="Values in this list will be used to filter the results. Add items to the list by choosing from the picklist above; click items in the list to remove them."
            >
            </select>
          </div>
          <div>
            <label for="toFilterValueList">To Values:</label>
            <select 
              id="toFilterValueList"
              multiple="true" 
              size="7"
              title="Values in this list will be used to filter the results. Add items to the list by choosing from the picklist above; click items in the list to remove them."
            >
            </select>
          </div>
        </section>
      </section>
      <footer>
        <button id="filterDialogOkButton">Ok</button>
        <button id="filterDialogClearButton">Clear</button>
        <button id="filterDialogCancelButton">Cancel</button>
      </footer>
    </dialog>
    
    <dialog id="errorDialog">
      <header>
        <h3 id="errorDialogTitle"></h3>
      </header>
      <section id="errorDialogDescription">
      </section>
      <footer>
        <button id="errorDialogOkButton">Ok</button>
      </footer>
    </dialog>
    
    <dialog id="settingsDialog">
      <header>
        <h3>Settings</h3>
      </header>
      <section 
        id="settingsTabs"
        role="tablist"
      >        
        <!--
          Datasources settings
        -->
        <div>
          <label 
            role="tab"
            for="datasourcesSettingTab"
          >
            Datasources
          </label>
          <input id="datasourcesSettingTab" type="radio" name="settingsTabs" class="tabState" checked="true"/>
          <div 
            role="tabpanel"
          >
            <form id="datasourceSettings">
              <label for="registeredFileTypes">UNION loose typing</label>
              <input id="useLooseColumnTypeComparison" type="checkbox"/>
            </form>
          </div>
        </div>
        <!--
          File settings
        -->
        <div>
          <label 
            role="tab"
            for="fileSettingTab"
          >
            Files
          </label>
          <input id="fileSettingTab" type="radio" name="settingsTabs" class="tabState"/>
          <div role="tabpanel">
            <form id="fileSettings">
              <label for="registeredFileTypes">File types</label>
              <select id="registeredFileTypes">
              </select>
              <label for="defaultActionForFileType">File type default action</label>
              <select id="defaultActionForFileType">
              </select>
            </form>
          </div>
        </div>
        
        <!--
          Locale Settings
        -->
        <div>
          <label 
            role="tab"
            for="localeSettingsTab"
          >
            Locale
          </label>
          <input id="localeSettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div role="tabpanel">
            <form id="localeSettings">
              <label for="useDefaultLocale">Use default</label>
              <input id="useDefaultLocale" type="checkbox"/>
              <!--
                see: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl
                A locale identifier is a string that consists of:

                A language subtag with 2–3 or 5–8 letters
                A script subtag with 4 letters Optional
                A region subtag with either 2 letters or 3 digits Optional
                One or more variant subtags (all of which must be unique), each with either 5–8 alphanumerals or a digit followed by 3 alphanumerals Optional
                One or more BCP 47 extension sequences Optional
                A private-use extension sequence Optional              
              -->
              <label for="locale">Locale</label>
              <!-- 
                on change we should try to call Intl.DisplayNames.supportedLocalesOf('DE-AU'). this will return an array
                and if that is empty it probably means the entered locale is either not valid or not supported.
              -->
              <input id="locale"  
                pattern="^(([A-Za-z]{2,3}|[A-Za-z]{5,8})(-[A-Za-z]{4})?(-([A-Za-z]{2}|\d{3}))?(-([0-9A-Za-z]{5,8}|\d[0-9A-Za-z]{3}))?)(\s*,\s*(([A-Za-z]{2,3}|[A-Za-z]{5,8})(-[A-Za-z]{4})?(-([A-Za-z]{2}|\d{3}))?(-([0-9A-Za-z]{5,8}|\d[0-9A-Za-z]{3}))?))*$"
                data-value-getter="new Function('control','settings','return control.value.split(String.fromCharCode(44));')"
                data-value-setter="new Function('control','value','settings','control.value = value.join();')"
              />
              <!-- minimum integer digits -->
              <label for="minimumIntegerDigits">Min. integer digits</label>
              <input id="minimumIntegerDigits" type="number" min="1" max="21" value="1"/>
              <!-- minimum fraction digits -->
              <label for="minimumFractionDigits">Min. fraction digits</label>
              <input id="minimumFractionDigits" type="number" min="0" max="20" value="2"/>
              <!-- maximum fraction digits -->
              <label for="maximumFractionDigits">Max. fraction digits</label>
              <input id="maximumFractionDigits" type="number" min="0" max="20" value="2"/>
            </form>
          </div>
        </div>
                
        <!--
          Query settings
        -->        
        <div>        
          <label 
            role="tab"
            for="querySettingsTab"
          >
            Query
          </label>
          <input id="querySettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div role="tabpanel">
            <form id="querySettings">
              <label for="autoRunQuery">Autorun Query</label>
              <input id="autoRunQuery" type="checkbox"/>
            </form>
          </div>
        </div>
        
        <!--
          Pivot Table Settings
        -->
        <div>
          <label 
            role="tab"
            for="pivotTableSettingsTab"
          >
            Pivot Table
          </label>
          <input id="pivotTableSettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div role="tabpanel">
            <form id="pivotTableSettings">
            </form>
          </div>
        </div>

        <!--
          Theme
        -->
        <div>
          <label 
            role="tab"
            for="themeSettingsTab"
          >
            Theme
          </label>
          <input id="themeSettingsTab" type="radio" name="settingsTabs" class="tabState"/>
          <div role="tabpanel">
            <form id="themeSettings">
              <label for="themes">Themes</label>
              <select 
                id="themes" 
                onchange="Theme.applyTheme(this.selectedIndex)"
                data-value-getter="new Function('control', 'settings', 'return JSON.parse(control.value);')"
                data-value-setter="new Function('control', 'value', 'settings', 'control.value = JSON.stringify(value);')"
              >
              </select>
            </form>
          </div>
        </div>
        
      </section>
      <footer>
        <button id="settingsDialogOkButton">Ok</button>
        <button id="settingsDialogCancelButton">Cancel</button>
      </footer>
    </dialog>

    <dialog id="aboutDialog">
      <header>
        <h3>Huey</h3>
      </header>
      <section>
        <p>
          A simple DuckDB UI - by Roland.Bouman@gmail.com
        </p>
        <ul>
          <li id="duckdbVersionLabel"></li>
          <li><a href="https://github.com/rpbouman/huey/" target="_github">Github</a></li>
          <li><a href="https://raw.githubusercontent.com/rpbouman/huey/dev/LICENSE" target="_github">License</a></li>
        </ul>
      </section>
      <footer>
        <button id="aboutDialogOkButton">Ok</button>
      </footer>
    </dialog>
        
    <main
      id="layout" 
      class="layout"
      style="display: none"
    >
      <menu class="toolbar" role="toolbar">
        <label for="uploader" title="Register local data files to analyze them with Huey">
          <input 
            id="uploader" 
            type="file"
            multiple="true"
            accept=".csv,.duckdb,.json,.parquet,.sql,.sqlite,.tsv,.xlsx"
          />
        </label>

        <label for="runQueryButton" title="Execute Query">
          <button
            id="runQueryButton"
          >Execute Query</button>
        </label>

        <label for="autoRunQuery" title="Check this if you want to execute the query automatically">Autorun Query</label>        

        <!-- title in the toolbar identifies the currently selected datasource -->
        <h1 id="currentDatasource"></h1>
        
        <label for="aboutButton" class="aboutButton" title="About Huey...">
          <button
            id="aboutButton"
          >About</button>
        </label>
        
        <label
          for="settingsButton"
          class="button settings"
          title="Open the Huey Settings dialog."
        >
          <button id="settingsButton">Settings</button>
        </label>
        
        <label for="downloadButton" class="button" title="Export &amp; Download queries and/or result data...">
          <button id="downloadButton">Download</button>
        </label>
      </menu>
      <nav 
        role="tablist"
        class="resizeHorizontal sidebar"
      >
        <!-- Datasources tab --> 
        <div 
         
        >
          <label 
            for="datasourcesTab" 
            role="tab"
            title="Files, database tables and so on that provide data you'd like to analyze."
          >Datasources</label>
          <input id="datasourcesTab" type="radio" name="sidebarTabs" class="tabState" checked="true"/>
          <div 
            role="tabpanel"
          >
            <div
              id="datasourcesUi" 
              role="tree"
            >
            </div>
          </div>
        </div>
        
        <!-- Attributes tab -->
        <div>
          <label 
            for="attributesTab" 
            role="tab"
            title="Columns, formulas and aggregates to query and pivot"
          >Attributes</label>
          <input id="attributesTab" type="radio" name="sidebarTabs" class="tabState"/>
          <div role="tabpanel">
            <search 
              id="searchAttributeUi"
              class="search" 
              style="display:none"
            >
              <fieldset>
                <legend>Search</legend>
                <input 
                  id="searchAttribute"
                  type="search"
                  placeholder="Search by Attribute name"
                />
              </fieldset>
            </search>
            <div 
              id="attributeUi" 
              class="attributeUi"
              style="flex-grow: 1;"
              role="tree"
            >
            </div>
          </div>          
        </div>
        
      </nav>
      <div class="workarea">
        <div 
          id="queryUi"
          class="queryUi" 
          data-cellheadersaxis="columns"
          style="display: none"
        >
          <template id="queryUiAxis">
            <section>
              <header>
                <label><button id="-axis-primary-action"></button></label>
                <h1>Axis Caption</h1>
              </header>
              <ol>
              </ol>
              <footer>
                <label title="Clear all items from this axis"><button id="-clear-axis">Clear axis</button></label>
              </footer>
            </section>
          </template>
          
          <template id="queryUiAxisItem">
            <li>
              <label title="Move this item to the left"><button id="-move-left">Move item left</button></label>
              <span>caption</span>
              <menu>
                <label title="Move this item to the other axis"><button id="-move-to-other-axis">Move item to other axis</button></label>
                <label title="Remove this item from the axis"><button id="-remove-from-axis">Remove item from axis</button></label>
              </menu>
              <label title="Move this item to the right"><button id="-move-right">Move item right</button></labe>
            </li>          
          </template>
          
        </div>
        <!-- pivotTableUi: outmost container of the pivot table-->
        <div
          id="pivotTableUi"
          class="pivotTableUiContainer"
          style="
            flex-grow: 1;
            width: 100%;
            height: 100%;
            border-width: 1px;
            border-color: var( --huey-dark-border-color );
            border-top-style: solid;
          "
          aria-busy="false"
          data-needs-update="false"
        >
          <div role="progressbar">
            <header>
              <div class="loader loader-medium">Loading...</div>
              <div class="timer">
                <span class="digit"></span>
                <span class="digit"></span>
                <span class="digit"></span>
                <span class="digit"></span>
              </div>
            </header>
            <section>
              <!-- TODO: actual progress information -->
            </section>
            <footer>
              <center>
                <button id="queryProgressCancelDialog">Cancel</button>
              </center`>
            </footer>
          </div>
          <div 
            class="pivotTableUiInnerContainer"
          >
            <!-- pivotTableColumnsSizer: sizer to generate the horizontal scrollbar -->
            <div class="pivotTableUiSizer pivotTableUiHorizontalSizer"></div>
            <!-- pivotTableColumnsSizer: sizer to generate the vertical scrollbar -->
            <div class="pivotTableUiSizer pivotTableUiVerticalSizer"></div>
            
            <!-- the actual table structure -->
            <div  
              class="pivotTableUiTable"
            >
              <div class="pivotTableUiTableHeader"></div>
              <div class="pivotTableUiTableBody"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <script onload="resourceLoaded(this.src)" src="util/dom/dom.js"></script>
    <script onload="resourceLoaded(this.src)" src="util/clipboard/clipboard.js"></script>
    <script onload="resourceLoaded(this.src)" src="util/event/EventEmitter.js"></script>
    <script onload="resourceLoaded(this.src)" src="util/event/EventBuffer.js"></script>

    <script onload="resourceLoaded(this.src)" src="SettingsDialog/SettingsDialog.js"></script>
    <script onload="resourceLoaded(this.src)" src="Theme/Theme.js"></script>

    <script onload="resourceLoaded(this.src)" src="util/sql/SQLHelper.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSource/duckdb/DuckDbDataSource.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSet/TupleSet.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSet/CellSet.js"></script>
    <script onload="resourceLoaded(this.src)" src="AboutDialog/AboutDialog.js"></script>
    <script onload="resourceLoaded(this.src)" src="ErrorDialog/ErrorDialog.js"></script>
    <script onload="resourceLoaded(this.src)" src="UploadUi/UploadUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="ExportUi/ExportUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="DataSource/DataSourcesUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="AttributeUi/AttributeUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="Search/Search.js"></script>
    <script onload="resourceLoaded(this.src)" src="QueryModel/QueryModel.js"></script>
    <script onload="resourceLoaded(this.src)" src="QueryUi/QueryUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="FilterUi/FilterUi.js"></script>
    <script onload="resourceLoaded(this.src)" src="PivotTableUi/PivotTableUi.js"></script>   

    <script onload="resourceLoaded(this.src)" src="App/App.js"></script>
    <script type="module">
      import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm';

      const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
      const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

      const worker_url = URL.createObjectURL(
        new Blob([`importScripts("${bundle.mainWorker}");`], {type: 'text/javascript'})
      );
      const worker = new Worker(worker_url);
      const logger = new duckdb.ConsoleLogger();
      const db = new duckdb.AsyncDuckDB(logger, worker);
      
      await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
      const connection = await db.connect();
      URL.revokeObjectURL(worker_url);    
      
      window.hueyDb = {
        duckdb: duckdb,
        instance: db,
        connection: connection
      };
      
      initApplication();
    </script>
  </body>
</html>